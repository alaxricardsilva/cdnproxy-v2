import { defineEventHandler, createError, getQuery } from 'h3'
import { requireSuperAdmin } from '../../../utils/supabase-auth'
import { createClient } from '@supabase/supabase-js'

export default defineEventHandler(async (event) => {
  try {
    // Obter configuração do runtime
    const config = useRuntimeConfig()

    // Validar autenticação e autorização com Supabase
    const user = await requireSuperAdmin(event)

    // Create Supabase client
    const supabase = createClient(
      config.supabaseUrl!,
      config.supabaseServiceKey!
    )

    // Parâmetros de consulta
    const query = getQuery(event)
    const limit = parseInt(query.limit as string) || 10
    const level = query.level as string
    const service = query.service as string

    // Buscar logs do sistema
    let logsQuery = supabase
      .from('system_logs')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(limit)

    if (level) {
      logsQuery = logsQuery.eq('level', level)
    }

    if (service) {
      logsQuery = logsQuery.eq('service', service)
    }

    const { data: logs, error } = await logsQuery

    if (error) {
      // Se a tabela não existir, retornar logs simulados
      if (error.code === 'PGRST116' || error.message.includes('relation "system_logs" does not exist')) {
        const mockLogs = [
          {
            id: 1,
            level: 'error',
            message: 'Database connection timeout on server-03',
            service: 'Database',
            created_at: new Date(Date.now() - 1000 * 60 * 5).toISOString(),
            details: { server: 'server-03', timeout: '30s' }
          },
          {
            id: 2,
            level: 'warning',
            message: 'High memory usage detected on server-01',
            service: 'Monitoring',
            created_at: new Date(Date.now() - 1000 * 60 * 15).toISOString(),
            details: { server: 'server-01', memory_usage: '85%' }
          },
          {
            id: 3,
            level: 'info',
            message: 'Cache cleared successfully',
            service: 'CDN',
            created_at: new Date(Date.now() - 1000 * 60 * 30).toISOString(),
            details: { cache_size: '2.4GB', duration: '1.2s' }
          },
          {
            id: 4,
            level: 'info',
            message: 'New user registered',
            service: 'Auth',
            created_at: new Date(Date.now() - 1000 * 60 * 45).toISOString(),
            details: { user_id: 'user_123', email: 'user@example.com' }
          },
          {
            id: 5,
            level: 'warning',
            message: 'SSL certificate expires in 7 days',
            service: 'Security',
            created_at: new Date(Date.now() - 1000 * 60 * 60).toISOString(),
            details: { domain: 'example.com', expires_at: '2025-01-20' }
          }
        ]

        // Aplicar filtros aos logs simulados
        let filteredLogs = mockLogs

        if (level) {
          filteredLogs = filteredLogs.filter(log => log.level === level)
        }

        if (service) {
          filteredLogs = filteredLogs.filter(log => log.service === service)
        }

        return {
          success: true,
          data: filteredLogs.slice(0, limit),
          mock: true
        }
      }

      throw error
    }

    return {
      success: true,
      data: logs || [],
      mock: false
    }

  } catch (error: any) {
    console.error('Erro ao buscar logs do sistema:', error)
    
    throw createError({
      statusCode: error.statusCode || 500,
      statusMessage: error.statusMessage || 'Erro interno do servidor'
    })
  }
})